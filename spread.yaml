project: chisel-releases

path: /chisel-releases

environment:
  PROJECT_PATH: /chisel-releases
  SHARED_LIBRARIES: $PROJECT_PATH/tests/spread/lib
  PATH: /snap/bin:$PATH:$SHARED_LIBRARIES

exclude:
  - .github

backends:
  lxd:
    type: adhoc
    allocate: |
      set -x
      sudo lxd init --auto
      release=$(echo $SPREAD_SYSTEM | awk -F '-' '{print $2}')
      # Ideally, we would add the ubuntu-minimal remote
      # e.g. https://cloud-images.ubuntu.com/minimal/releases/jammy/
      # but that would effectively change the host's LXC configurations.
      echo "Allocating $SPREAD_SYSTEM..."
      sudo lxc launch --ephemeral ubuntu:$release $SPREAD_SYSTEM
      until sudo lxc exec $SPREAD_SYSTEM -- pgrep sshd &>/dev/null
      do
        sleep 5
      done
      sudo lxc exec $SPREAD_SYSTEM -- sed -i 's/^\s*#\?\s*\(PermitRootLogin\|PasswordAuthentication\)\>.*/\1 yes/' /etc/ssh/sshd_config
      sudo lxc exec $SPREAD_SYSTEM -- bash -c "sed -i 's/^\s*\(PermitRootLogin\|PasswordAuthentication\)\>.*/# COMMENTED OUT BY SPREAD: \0/' /etc/ssh/sshd_config.d/* || true"
      sudo lxc exec $SPREAD_SYSTEM -- bash -c "test -d /etc/ssh/sshd_config.d && echo -e 'PermitRootLogin=yes\nPasswordAuthentication=yes' > /etc/ssh/sshd_config.d/00-spread.conf"
      sudo lxc exec $SPREAD_SYSTEM -- bash -c "echo root:${SPREAD_SYSTEM_PASSWORD} | chpasswd"
      sudo lxc exec $SPREAD_SYSTEM -- killall -HUP sshd
      ADDRESS `sudo lxc list --format=json $SPREAD_SYSTEM | jq -r '.[0].state.network.eth0.addresses[] | select(.family=="inet") | .address'`
    discard: sudo lxc stop $SPREAD_SYSTEM || true
    systems:
      - ubuntu-jammy:
          password: ubuntu

prepare: |
  # Deb arch to GOARCH
  arch="$(dpkg --print-architecture | sed -e 's/armhf/arm/g' -e 's/ppc64el/ppc64le/g')"
  chisel_tar="chisel.tar.gz"

  apt install -y curl wget
  echo $(curl -i https://api.github.com/repos/canonical/chisel/releases/latest)
  curl -s https://api.github.com/repos/canonical/chisel/releases/latest \
    | awk "/browser_download_url/ && /chisel_v/ && /$arch/" \
    | cut -d : -f 2,3 \
    | xargs wget -O $chisel_tar

  tar -xf $chisel_tar -C /usr/local/bin

prepare-each: chisel version

suites:
  tests/spread/integration/:
    summary: Tests common scenarios
