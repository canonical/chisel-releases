name: Install slices

on:
  push:
    branches:
      - "main"
    paths:
      - ".github/**"
  pull_request:
    branches:
      - "main"
    paths:
      - ".github/**"
  schedule:
    # Run at 00:00 every day.
    # Ref: https://man7.org/linux/man-pages/man5/crontab.5.html
    - cron: "0 0 * * *"
  workflow_call:

env:
  # Package architectures and chisel-releases branches to test on.
  ARCHES: ${{ toJson('["amd64","arm64","armhf","i386","ppc64el","riscv64","s390x"]') }}
  RELEASES: ${{ toJson('["ubuntu-20.04","ubuntu-22.04","ubuntu-23.10","ubuntu-24.04"]') }}

jobs:
  prepare-install:
    runs-on: ubuntu-latest
    name: "Prepare to install"
    outputs:
      install-all: ${{ steps.set-output.outputs.install_all }}
      matrix: ${{ steps.set-output.outputs.matrix }}
    steps:
      - name: Set output
        id: set-output
        run: |
          set -ex
          if [[
            "${{ github.base_ref || github.ref_name }}" == "main" ||
            "${{ github.event_name }}" == "schedule"
          ]]; then
            echo "matrix={\"ref\":${{ env.RELEASES }},\"arch\":${{ env.ARCHES }}}" >> $GITHUB_OUTPUT
            echo "install_all=true" >> $GITHUB_OUTPUT
          else
            echo "matrix={\"arch\":${{ env.ARCHES }}}" >> $GITHUB_OUTPUT
          fi

  # The "install" job tests the slices by installing them.
  # It installs **all** slices if:
  #   - chisel.yaml is changed
  #   - any slice definition files are deleted
  #   - github workflows (and related files) are changed
  # Otherwise, it installs only the slices from **added** and/or
  # **modified** slice definition files.
  # Please note that "change" is defined to encompass additions,
  # modifications and deletions here.
  install:
    runs-on: ubuntu-latest
    name: "Install"
    needs: prepare-install
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-install.outputs.matrix) }}
    env:
      install-all: ${{ needs.prepare-install.outputs.install-all }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ matrix.ref }}

      - name: Check changed paths
        id: changed-paths
        if: env.install-all != 'true'
        uses: dorny/paths-filter@v3
        with:
          # ref: https://github.com/marketplace/actions/paths-changes-filter
          filters: |
            install-all:
              - 'chisel.yaml'
              - deleted: 'slices/**/*.yaml'
              - '.github/**'
            slices:
              - added|modified: 'slices/**/*.yaml'
          # Space delimited list usable as command-line argument list in
          # Linux shell. If needed, it uses single or double quotes to
          # wrap filename with unsafe characters.
          list-files: shell

      - name: Setup Go environment
        uses: actions/setup-go@v5

      - name: Install dependencies
        run: |
          go install github.com/canonical/chisel/cmd/chisel@latest
          go install github.com/mikefarah/yq/v4@latest
          wget -q https://raw.githubusercontent.com/canonical/chisel-releases/main/.github/scripts/install-slices
          chmod +x install-slices

      - name: Install slices
        run: |
          set -ex
          if [[
            "${{ env.install-all }}" == "true" ||
            "${{ steps.changed-paths.outputs.install-all }}" == "true"
          ]]; then
            # Install all slices in slices/ dir.
            # We need to enable globstar to use the ** patterns below.
            shopt -s globstar
            ./install-slices --arch "${{ matrix.arch }}" --release ./ \
              slices/**/*.yaml
          elif [[ "${{ steps.changed-paths.outputs.slices }}" == "true" ]]; then
            # Install slices from changed files.
            ./install-slices --arch "${{ matrix.arch }}" --release ./ \
              ${{ steps.changed-paths.outputs.slices_files }}
          fi
