package: ca-certificates

essential:
  - ca-certificates_copyright

slices:
  data:
    essential:
      # This adds the symlink at `etc/ssl/certs.pem` for OpenSSL to look up the
      # bundled certificate file. See `openssl_data` for details.
      - openssl_data
    contents:
      # This bundle of certificates and the config are the results of running
      # the `update-ca-certificates` script. This script is run by default
      # by the postinst maintainer script when installed as a deb package.
      /etc/ca-certificates.conf: {text: FIXME, mutable: true}
      /etc/ssl/certs/ca-certificates.crt: {text: FIXME, mutable: true}
      /usr/share/ca-certificates/mozilla/: {until: mutate}
      /usr/share/ca-certificates/mozilla/*: {until: mutate}
    mutate: |
      certs_dir = "/usr/share/ca-certificates/mozilla/"
      certs = []
      names = []
      for path in content.list(certs_dir):
        certs.append(content.read(certs_dir + path))
        names.append("mozilla/{}".format(path))

      content.write("/etc/ssl/certs/ca-certificates.crt", "".join(certs))
      content.write("/etc/ca-certificates.conf", "\n".join(names))

  # The `_data` slice only provides the bundled certificates and the config file.
  # To keep the individual certificates, this slice should be included.
  data-with-certs:
    essential:
      - ca-certificates_data
    contents:
      /usr/share/ca-certificates/mozilla/*:

  bins:
    essential:
      - openssl_bins
      # The `/usr/sbin/update-ca-certificates` script requires sed to run.
      - sed_bins
    contents:
      # To run update-ca-certificates without breaking the default certificates
      # at /etc/ssl/certs/ca-certificates.crt, the `_data-with-certs` slice should
      # also be included. For details, see the `update-ca-certificates` script.
      /usr/sbin/update-ca-certificates:

  copyright:
    contents:
      /usr/share/doc/ca-certificates/copyright:
