package: ca-certificates

essential:
  - ca-certificates_copyright

slices:
  # This slice only contains the certificates bundle at /etc/ssl/certs/ca-certificates.crt.
  # To keep the individual certificates at /usr/share/ca-certificates/mozilla/ or the
  # configuration file at /etc/ca-certificates.conf, please use the "data-with-certs" slice.
  # Please note that the mutation script (partially) mimics the deb's maintainer
  # scripts to generate the certificates bundle.
  data:
    essential:
      # This adds the symlink at etc/ssl/certs.pem for OpenSSL to look up the
      # bundled certificate file. See "openssl_data" for details.
      - openssl_data
    contents:
      /etc/ssl/certs/ca-certificates.crt: {text: FIXME, mutable: true}
      /usr/share/ca-certificates/mozilla/: {until: mutate}
      /usr/share/ca-certificates/mozilla/**: {until: mutate}
    mutate: |
      certs_dir = "/usr/share/ca-certificates/mozilla/"
      certs = [
        content.read(certs_dir + path) for path in content.list(certs_dir)
      ]
      content.write("/etc/ssl/certs/ca-certificates.crt", "".join(certs))

  # This slice offers a standard chunk of the ca-certificates package.
  # It contains the default certificates at /usr/share/ca-certificates/mozilla,
  # a certificates bundle at /etc/ssl/certs/ca-certificates.crt and a config
  # file at /etc/ca-certificates.conf.
  data-with-certs:
    essential:
      - ca-certificates_data
    contents:
      # This config file is generated by the deb's maintainer scripts.
      /etc/ca-certificates.conf: {text: FIXME, mutable: true}
      /usr/share/ca-certificates/mozilla/**:
    mutate: |
      certs_dir = "/usr/share/ca-certificates/mozilla/"
      names = [
        "mozilla/{}".format(name) for name in content.list(certs_dir)
      ]
      content.write("/etc/ca-certificates.conf", "\n".join(names))

  # Kept to avoid breaking existing users of this slice.
  data-no-certs:
    essential:
      - ca-certificates_data

  bins:
    essential:
      - base-files_bin
      - base-files_tmp
      # Manually linking /bin/sh to /bin/bash is required as /bin/sh is hardcoded in
      # the shebang of the script.
      # See https://github.com/canonical/chisel-releases/pull/61#discussion_r1326873419
      - bash_bins
      - coreutils_bins
      - findutils_bins
      - openssl_bins
      - sed_bins
    contents:
      # To run update-ca-certificates without breaking the default certificates
      # at /etc/ssl/certs/ca-certificates.crt, the "_data-with-certs" slice should
      #  also be included. For details, see the `update-ca-certificates` script.
      /usr/sbin/update-ca-certificates:

  copyright:
    contents:
      /usr/share/doc/ca-certificates/copyright:
