package: apt

essential:
  - apt_copyright

slices:
  config:
    contents:
      /etc/apt/apt.conf.d/01-vendor-ubuntu:
      /etc/apt/apt.conf.d/01autoremove:
      /etc/apt/auth.conf.d/:
      /etc/apt/keyrings/:
      /etc/apt/preferences.d/:
      /etc/apt/sources.list.d/:
      /etc/apt/trusted.gpg.d/:

  apt-get:
    essential:
      - apt_config
      - apt_default-source-list
      - apt_var
      - base-files_bin
      - base-files_tmp
      - dpkg_maintscript-support
      - gpgv_bins
      - libapt-pkg7.0_libs
      - libc6_libs
      - libgcc-s1_libs
      - libgnutls30t64_libs
      - libseccomp2_libs
      - libssl3t64_libs
      - libstdc++6_libs
      - libsystemd0_libs
    contents:
      /usr/bin/apt:
      /usr/bin/apt-config:
      /usr/bin/apt-get:
      /usr/bin/apt-mark:
      /usr/lib/*-linux-*/libapt-private.so*:
      /usr/lib/apt/methods/gpgv:
      /usr/lib/apt/methods/http:
      /usr/lib/apt/methods/https:  # Symlink to http
      /usr/lib/apt/methods/store:

  var:
    contents:
      /var/cache/apt/archives/partial/:
      /var/lib/apt/lists/partial/:
      /var/log/apt/:

  # The default source list is generated by the `debootstrap` tool upon the
  # bootstrapping of the root filesystem. This slice provides the content in
  # the generated source list.
  default-source-list:
    essential:
      - ubuntu-keyring_keys
    contents:
      /etc/apt/sources.list.d/ubuntu-default.sources:
        arch: [amd64, i386]
        until: mutate
        text: |
          Types: deb
          URIs: http://archive.ubuntu.com/ubuntu/
          Suites: plucky plucky-updates plucky-backports
          Components: main universe restricted multiverse
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg

          Types: deb
          URIs: http://security.ubuntu.com/ubuntu/
          Suites: plucky-security
          Components: main universe restricted multiverse
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg
      /etc/apt/sources.list.d/ubuntu-ports-default.sources:
        arch: [arm64, armhf, ppc64el, riscv64, s390x]
        until: mutate
        text: |
          Types: deb
          URIs: http://ports.ubuntu.com/ubuntu-ports/
          Suites: plucky plucky-updates plucky-backports
          Components: main universe restricted multiverse
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg

          Types: deb
          URIs: http://ports.ubuntu.com/ubuntu-ports/
          Suites: plucky-security
          Components: main universe restricted multiverse
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg
      /etc/apt/sources.list.d/ubuntu.sources: {text: "", mutable: true}
    mutate: |
      files = content.list("/etc/apt/sources.list.d/")
      sources = ""
      for f in ["ubuntu-ports-default.sources", "ubuntu-default.sources"]:
        if f in files:
          sources = content.read("/etc/apt/sources.list.d/" + f)
          break
      content.write("/etc/apt/sources.list.d/ubuntu.sources", sources)

  # Minimal apt-get slice. This slice provides just enough functionality
  # for apt to be able to update its package lists and reinstall itself.
  # It does not provide all the features of the full apt package.
  # Run the following command before using apt:
  #   apt-get update && apt-get install -y coreutils dpkg apt
  apt-get-mini:
    essential:
      - apt_apt-get-mini-support-apt  # to be able to reinstall apt with itself
      - apt_config
      - apt_default-source-list
      - apt_var
      - base-files_bin  # /bin -> /usr/bin link
      - base-files_tmp  # /tmp
      - dpkg_dpkg
      - dpkg_tables  # we need tabled to do update
      - dpkg_var  # we need /var/lib/dpkg/ to exist to get the lockfile
      - gpgv_bins
      - libapt-pkg7.0_libs
      - libc6_libs
      - libgcc-s1_libs
      - libgnutls30t64_libs
      - libseccomp2_libs
      - libssl3t64_libs
      - libstdc++6_libs
      - libsystemd0_libs
    contents:
      /usr/bin/apt:
      /usr/bin/apt-get:
      /usr/lib/*-linux-*/libapt-private.so*:
      /usr/lib/apt/methods/gpgv:
      /usr/lib/apt/methods/http:
      /usr/lib/apt/methods/https:  # Symlink to http
      /usr/lib/apt/methods/store:

  # Packages required to reinstall apt with itself
  # do that if the reduced apt installation fails at installing
  # some dependencies (for example due to lack of maintainer script
  # support) dpkg
  apt-get-mini-support-apt:
    essential:
      - coreutils_uname  # needed for libc6 preinst
      - dpkg_dpkg-divert
      - dpkg_dpkg-trigger
      - dpkg_update-alternatives
      - sed_bins  # needed for libc6 preinst

      # NOTE: In the future, when `prefer` is supported, we can
      # replace the dpkg-divert, dpkg-trigger and update-alternatives
      # above with empty stub files:
      # /usr/bin/dpkg-divert:
      #   text: ""
      #   mode: 0755
      #   prefer: dpkg
      # /usr/bin/dpkg-trigger:
      #   text: ""
      #   mode: 0755
      #   prefer: dpkg
      # /usr/bin/update-alternatives:
      #   text: ""
      #   mode: 0755
      #   prefer: dpkg

  copyright:
    contents:
      /usr/share/doc/apt/copyright:
