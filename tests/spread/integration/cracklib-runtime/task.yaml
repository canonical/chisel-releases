summary: Integration tests for cracklib-runtime

execute: |
  rootfs="$(install-slices bash_bins base-files_base coreutils_bins cracklib-runtime_bins)"

  chroot "${rootfs}" ln -s /usr/bin/bash /bin/sh
  chroot "${rootfs}" /usr/sbin/update-cracklib

  if ! [ -e "${rootfs}"/var/cache/cracklib/cracklib_dict.hwm ]; then
    echo "expected /var/cache/cracklib/cracklib_dict.hwm to exist"
    exit -1
  fi

  if ! [ -e "${rootfs}"/var/cache/cracklib/cracklib_dict.pwd ]; then
    echo "expected /var/cache/cracklib/cracklib_dict.pwd to exist"
    exit -1
  fi

  if ! [ -e "${rootfs}"/var/cache/cracklib/cracklib_dict.pwi ]; then
    echo "expected /var/cache/cracklib/cracklib_dict.pwi to exist"
    exit -1
  fi

  if ! [ -e "${rootfs}"/var/cache/cracklib/src-dicts ]; then
    echo "expected /var/cache/cracklib/src-dicts to exist"
    exit -1
  fi

  # copy files in
  cp ./lower.tar.gz "${rootfs}"
  cp ./test.sh "${rootfs}"
  sed -i -e 's/-v/-v -a/g' "${rootfs}/usr/sbin/cracklib-format"

  # run tests
  chroot "${rootfs}" /test.sh
