summary: Integration tests for RabbitMQ

execute: |
  # These tests only run for amd64 and arm64
  # For this test we also need libc-bin_getconf
  slices="rabbitmq-server_bins libc-bin_getconf \
    erlang-base_bins erlang-inets_scripts erlang-os-mon_bins \
    erlang-crypto_modules erlang-eldap_modules erlang-mnesia_modules erlang-parsetools_modules erlang-public-key_modules erlang-runtime-tools_modules erlang-ssl_modules erlang-syntax-tools_modules erlang-tools_modules erlang-xmerl_modules"
  rootfs="$(install-slices ${slices})"

  cp /bin/sh "$rootfs"/bin/
  chroot "$rootfs" mkdir /dev /proc
  mount --bind /proc "$rootfs"/proc
  chroot "$rootfs" touch /dev/null
  chroot "$rootfs" chmod 777 /dev/null
  chroot "$rootfs" mkdir -p /var/lib/rabbitmq/mnesia /var/log/rabbitmq /etc/rabbitmq
  chroot "$rootfs" useradd -r -d /var/lib/rabbitmq rabbitmq
  chroot "$rootfs" chown -R rabbitmq /var/lib/rabbitmq /var/log/rabbitmq /etc/rabbitmq
  chroot "$rootfs" /usr/lib/rabbitmq/bin/rabbitmqctl version

  # Server test
  chroot "$rootfs" /usr/lib/rabbitmq/bin/rabbitmqctl status || echo "RabbitMQ not running"
  chroot "$rootfs" /usr/lib/rabbitmq/bin/rabbitmq-server -detached
  sleep 10
  chroot "$rootfs" /usr/lib/rabbitmq/bin/rabbitmqctl status && echo "RabbitMQ is running now!"

restore: |
  # Kill the RabbitMQ server, which by default runs on port 25672
  kill `sudo lsof -t -i :25672`
