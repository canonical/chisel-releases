summary: Integration tests for RabbitMQ

execute: |
  rootfs="$(install-slices influxdb_bins)"
  chroot "$rootfs" /usr/bin/influxd &
  daemon_pid=$!

  # Wait for daemon to start
    while ! fuser 8086/tcp > /dev/null 2>&1
    do
      if ! test -d /proc/$daemon_pid 
      then
        echo "daemon exited early"
        exit 1
      fi
      sleep 1
    done

  # Arrange test
  data_point="test_measurement,tag_key=tag_value value=0.64 1434055562000000000"
  expected_result={"results":[{"statement_id":0,"series":[{"name":"test_measurement","columns":["time","tag_key","value"],"values":[["2015-06-11T20:46:02Z","tag_value",0.64]]}]}]}
  
  # Act
  curl -i -XPOST http://127.0.0.1:8086/query --data-urlencode "q=CREATE DATABASE testdb"
  curl -i -XPOST 'http://127.0.0.1:8086/write?db=testdb' --data-binary "${data_point}"

  result=$(curl -G 'http://127.0.0.1:8086/query?db=testdb' --data-urlencode 'q=SELECT * FROM "test_measurement"')
  kill -INT $(fuser 8086/tcp  2>/dev/null)

  # Assert
  if expected_result != result
  then
    exit 1
  fi
