summary: Integration tests for golang

execute: |
  apt install --update -y gcc git
  # replace _ with -
  arch=$(gcc -dumpmachine)
  arch="${arch//_/-}"

  rootfs="$(install-slices golang_cgo-support \
    binutils-${arch}_assembler \
    binutils-${arch}_linker \
    cpp-13-${arch}_libs \
    gcc-13-${arch}_gcc-13 \
    gcc-13-${arch}_libs \
    ca-certificates_data \  # for go get ...
    )"

  find ${rootfs}/usr/share/go-1.22 -depth \( \
    \( -path '*test*' ! -path '*src/testing*' ! -path '*src/internal/test*' \) -o \
    \( -path '*/testing/*' -name '*_test.go' \) \
    \) -exec rm -rf {} +

  mkdir "${rootfs}/proc"
  mount --bind /proc "${rootfs}/proc"

  mkdir "${rootfs}/dev"
  mount --bind /dev "${rootfs}/dev"

  mkdir -p "${rootfs}/tmp"

  mkdir "${rootfs}/app"
  cp -r hello "${rootfs}/"

  chroot "${rootfs}/" go version
  chroot "${rootfs}/" go run /hello/cmd/hello/main.go | grep "Hello, World!"

  chroot "${rootfs}/" gofmt /hello/cmd/hello/main.go > /dev/null

  chroot "${rootfs}/" go -C /hello test

  git clone https://github.com/canonical/chisel.git "${rootfs}/chisel"
  pushd "${rootfs}/chisel" && git checkout v1.1.0 && popd
  cp /etc/resolv.conf "${rootfs}/etc/resolv.conf"

  chroot "${rootfs}/" go -C chisel build ./cmd/chisel
  chroot "${rootfs}/" ./chisel/chisel 2>&1 > /dev/null

  export CGO_ENABLED=1
  chroot "${rootfs}/" go run /hello/cmd/hello_cgo/main_cgo.go | grep "Hello from C!"

  umount "${rootfs}/proc"
  umount "${rootfs}/dev"
  rm -rf "${rootfs}/proc"
  rm -rf "${rootfs}/dev"
