summary: Integration tests for golang

execute: |
  rootfs="$(install-slices golang_cgo-support \
    binutils-x86-64-linux-gnu_assembler \
    binutils-x86-64-linux-gnu_linker \
    cpp-13-x86-64-linux-gnu_libs \
    gcc-13-x86-64-linux-gnu_gcc-13 \
    gcc-13-x86-64-linux-gnu_libs \
    )"

  find . -depth \( \
    \( -path '*test*' ! -path '*src/testing*' \) -o \
    \( -path '*/testing/*' -name '*_test.go' \) \
    \) -exec rm -rf {} +

  mkdir "${rootfs}/proc"
  mount --bind /proc "${rootfs}/proc"

  mkdir "${rootfs}/dev"
  mount --bind /dev "${rootfs}/dev"

  mkdir -p "${rootfs}/tmp"

  mkdir "${rootfs}/app"
  cp main.go "${rootfs}/app/"
  cp main_cgo.go "${rootfs}/app/"

  chroot "${rootfs}/" go version
  chroot "${rootfs}/" go run /app/main.go | grep "hello world"

  chroot "${rootfs}/" gofmt /app/main.go > /dev/null

  export CGO_ENABLED=1
  chroot "${rootfs}/" go run /app/main_cgo.go | grep "Hello from C!"

  umount "${rootfs}/proc"
  umount "${rootfs}/dev"
  rm -rf "${rootfs}/proc"
  rm -rf "${rootfs}/dev"
