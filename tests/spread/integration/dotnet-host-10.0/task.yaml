summary: Integration tests for .NET 10 Host 

variants:
    - +WithoutLibicu
    - +WithLibicu
    - +WithDNX

environment:
  # needed, because libicu is not installed
  DOTNET_SYSTEM_GLOBALIZATION_INVARIANT/WithoutLibicu: "true"
  # install sdk to enable dnx run
  DOTNET_SYSTEM_GLOBALIZATION_INVARIANT/WithDNX: "true"
  # disable noisy help text for users who run .NET for the first time
  DOTNET_NOLOGO: "true"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"

prepare: |
  required_slices=(dotnet-runtime-10.0_core dotnet-host-10.0_bins)
  if [[ ! -v DOTNET_SYSTEM_GLOBALIZATION_INVARIANT ]]; then
    required_slices+=(libicu78_libs)
  fi

  if [[ -v WITH_DNX ]]; then
    required_slices+=(dotnet-sdk-10.0_core dotnet-host-10.0_dnx)
  fi
  
  # install slices
  rootfs="$(install-slices ${required_slices[@]})"
  echo "$rootfs" > ROOTFS

execute: |
  rootfs="$(cat ROOTFS)"
  
  # smoking test the .NET host
  chroot "${rootfs}" /usr/bin/dotnet --info

  if [[ -v WITH_DNX ]]; then
    output="$(chroot "${rootfs}" /usr/bin/dnx dotnetsay "Hello, World!")"
    grep -q "Hello, World!" <<< "${output}"
  fi
