summary: Integration tests for tomcat10-common

environment:
  SLICE/core: "core"
  SLICE/extrascripts: "extra-scripts"

execute: |
  rootfs="$(install-slices tomcat10-common_${SLICE})"
  java=$(find "$rootfs" -name java -type f -printf '%P\n' -quit 2>/dev/null)

  # Make fake /dev/null and mount /proc
  mkdir -p "$rootfs/dev"
  touch "$rootfs/dev/null"
  chmod +x "$rootfs/dev/null"
  mkdir -p "$rootfs/proc"
  sudo mount --bind /proc "$rootfs/proc"
  trap 'sudo umount "$rootfs/proc"' EXIT

  export JAVA_HOME="/$(dirname $(dirname ${java}))"
  export CATALINA_BASE="/var/lib/tomcat10"

  case ${SLICE} in
    core)
      chroot "$rootfs" /usr/share/tomcat10/bin/catalina.sh version \
        | grep -q "Apache Tomcat/10"
    ;;
    extra-scripts)
      chroot "$rootfs" /usr/share/tomcat10/bin/ciphers.sh \
        | grep -q TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
      # /usr/share/tomcat10/bin/configtest.sh - needs full configuration
      # /usr/share/tomcat10/bin/daemon.sh - needs full configuration
      chroot "$rootfs" /usr/share/tomcat10/bin/digest.sh foo \
         | grep -q "foo"
      chroot "$rootfs" /usr/share/tomcat10/bin/makebase.sh foo \
        | grep -q "Created CATALINA_BASE directory at foo"
      chroot "$rootfs" /usr/share/tomcat10/bin/version.sh \
        | grep -q "Apache Tomcat"
    ;;
  esac
