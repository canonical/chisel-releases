summary: Integration tests for apache2

environment:
  SLICE/core: "core"
  SLICE/standard: "standard"

execute: |
  echo "SLICE=${SLICE}"

  # Install slices
  rootfs="$(install-slices apache2_${SLICE} base-files_base base-passwd_data)"

  # Create required directories
  mkdir -p "$rootfs/run/apache2"
  mkdir -p "$rootfs/var/www/html"

  # Run test based on slice type
  if [ "$SLICE" = "standard" ]; then

    # Create minimal /dev/null 
    mkdir -p "$rootfs/dev"
    touch "$rootfs/dev/null"
    chmod +x "$rootfs/dev/null"

    # Use configtest utility to verify configuration
    chroot "$rootfs" /usr/sbin/apache2ctl configtest | grep "Syntax OK" || exit 1

    # Trap the apachectl stop on exit
    trap 'chroot "$rootfs" /usr/sbin/apachectl stop 2>/dev/null || true' EXIT

    # Start apache2 via apachectl
    chroot "$rootfs" /usr/sbin/apachectl start
    sleep 2

    # Test the default page is present
    curl -s http://127.0.0.1/index.html || exit 1

    # Test the restart script
    chroot "$rootfs" /usr/sbin/apachectl restart
    sleep 2

    # Check the page still works after restart
    curl -s http://127.0.0.1/index.html

    # Stop via apachectl
    chroot "$rootfs" /usr/sbin/apachectl stop

    # Test the scripts
    chroot "$rootfs" /usr/sbin/a2enmod ssl
    chroot "$rootfs" /usr/sbin/a2query -m ssl | grep "ssl (enabled by"
    chroot "$rootfs" /usr/sbin/a2dismod ssl
    ! chroot "$rootfs" /usr/sbin/a2query -m | grep "ssl"

    chroot "$rootfs" /usr/sbin/a2query -s 000-default
    chroot "$rootfs" /usr/sbin/a2dissite 000-default
    ! chroot "$rootfs" /usr/sbin/a2query -s | grep "000-default"

    chroot "$rootfs" /usr/sbin/a2query -c charset
    chroot "$rootfs" /usr/sbin/a2disconf charset
    ! chroot "$rootfs" /usr/sbin/a2query -c | grep "charset"
    
  else
    # Manually export envvars and run apache2
    env -i bash -c '
      . "'"$rootfs"'/etc/apache2/envvars"
      exec chroot "'"$rootfs"'" /usr/sbin/apache2 -D FOREGROUND
    ' &
    apache2_pid=$!
    sleep 2

    # Trap to ensure apache2 is killed on exit
    trap "kill $apache2_pid 2>/dev/null || true" EXIT

    # Test apache2 is running by checking the default page
    curl -s http://127.0.0.1/
  fi
