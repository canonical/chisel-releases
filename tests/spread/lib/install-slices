#!/bin/bash -ex
# spellchecker: ignore rootfs

# Installs one or more slices into a dynamically created temporary path.
# Usage: install-slices [<slice>...]
# Returns the path of the chiselled rootfs

function main() {
    local slices="$*"
    # add base-files_chisel slice to ensure we generate the manifest
    slices="${slices} base-files_chisel"

    local rootfs="$(mktemp -d)"
    #shellcheck disable=SC2086
    chisel cut --release "$PROJECT_PATH" --root "$rootfs" $slices
    [ -n "$MANIFESTS_EXPORT_DIR" ] && export_manifests "$rootfs" "$MANIFESTS_EXPORT_DIR"

    echo "${rootfs}"
}

function export_manifests() {
    # copy the manifests to a common export directory
    # manifest is at $rootfs/var/lib/chisel/manifest.wall
    # it will be copied to $manifests_export_dir/$test_name/manifestXXXXX.wall where
    # XXXXX is sequence number (starting from 00000)
    # note that install_slices can be called multiple times from the same test
    local rootfs="$1"
    local manifests_export_dir="$2"
    local test_name=$(basename "$PWD")
    test_name=${test_name:-default}
    local export_dir="$manifests_export_dir/$test_name"
    mkdir -p "$export_dir"
    local seq=$(find "$export_dir" -type f -name 'manifest_*.wall' | wc -l)
    cp "$rootfs/var/lib/chisel/manifest.wall" "$export_dir/manifest_$(printf "%05d" "$seq").wall"
}

main "$@"
